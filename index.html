<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PDF阅读器 - 翻页修复版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        :root {
            --navy-blue: #001f3f;
            --deep-blue: #003366;
            --ocean-blue: #005b96;
            --light-blue: #3498db;
            --silver: #ecf0f1;
            --gold: #f1c40f;
            --text-light: #f8f9fa;
            --text-gray: #e0e0e0;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: linear-gradient(135deg, var(--navy-blue), var(--deep-blue));
            font-family: 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
            color: var(--text-light);
        }

        body {
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overscroll-behavior: none;
            padding: 0;
        }

        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--navy-blue), var(--deep-blue));
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            transition: opacity 0.5s;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top-color: var(--light-blue);
            border-radius: 50%;
            animation: spin 1.2s linear infinite;
            margin-bottom: 30px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            color: var(--text-gray);
            font-size: 18px;
            font-weight: 500;
            letter-spacing: 1px;
        }
        
        #error-message {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 16px 20px;
            background: #c0392b;
            color: white;
            text-align: center;
            z-index: 1001;
            font-size: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            font-weight: 500;
        }

        .app-title {
            position: fixed;
            top: 25px;
            left: 25px;
            font-size: 22px;
            font-weight: 600;
            color: var(--text-light);
            z-index: 10;
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0.9;
        }
        
        .app-title i {
            color: var(--gold);
        }

        #pdf-container {
            position: relative;
            width: 95%;
            max-width: 100%;
            height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 60px);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            padding: 10px;
            box-sizing: border-box;
            margin-top: 20px;
            cursor: pointer;
        }

        #pdf-canvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            touch-action: none;
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.4);
            background: white;
            border-radius: 6px;
            image-rendering: -webkit-optimize-contrast;
            image-rendering: crisp-edges;
        }

        .page-indicator {
            position: fixed;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 31, 63, 0.9);
            color: var(--text-light);
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 17px;
            z-index: 10;
            transition: opacity 0.3s;
            backdrop-filter: blur(10px);
            font-weight: 500;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.15);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .nav-btn {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 60px;
            background: rgba(0, 53, 102, 0.9);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
            opacity: 0.9;
            transition: all 0.25s ease;
            backdrop-filter: blur(8px);
            border: 2px solid rgba(52, 152, 219, 0.4);
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        
        .nav-btn:hover {
            opacity: 1;
            transform: translateY(-50%) scale(1.05);
            background: rgba(0, 91, 150, 0.95);
            border-color: rgba(52, 152, 219, 0.6);
        }
        
        .prev-btn {
            left: 25px;
        }
        
        .next-btn {
            right: 25px;
        }
        
        .nav-btn i {
            font-size: 28px;
            color: var(--text-light);
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            z-index: 15;
            background: rgba(0, 31, 63, 0.85);
            padding: 12px 25px;
            border-radius: 50px;
            backdrop-filter: blur(10px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(0, 53, 102, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.25s;
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        
        .control-btn:hover {
            background: rgba(0, 91, 150, 0.9);
            transform: scale(1.1);
        }
        
        .control-btn i {
            font-size: 22px;
            color: var(--text-light);
        }

        .quality-toggle {
            position: fixed;
            top: 25px;
            right: 25px;
            background: rgba(0, 31, 63, 0.9);
            color: var(--text-light);
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 15px;
            z-index: 10;
            backdrop-filter: blur(10px);
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(52, 152, 219, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .quality-toggle:hover {
            background: rgba(0, 91, 150, 0.95);
        }
        
        .quality-toggle i {
            margin-right: 8px;
            color: var(--gold);
        }

        .scale-indicator {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 31, 63, 0.85);
            color: var(--text-light);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 15px;
            z-index: 10;
            backdrop-filter: blur(10px);
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(52, 152, 219, 0.3);
            opacity: 0;
            transition: opacity 0.3s;
        }

        /* 翻页区域指示器 */
        .page-nav-area {
            position: absolute;
            top: 0;
            height: 100%;
            width: 30%;
            opacity: 0.3;
            z-index: 5;
            transition: background 0.3s;
        }
        
        .prev-area {
            left: 0;
            background: var(--ocean-blue);
        }
        
        .next-area {
            right: 0;
            background: var(--ocean-blue);
        }
        
        .page-nav-area:hover {
            opacity: 0.2;
        }

        @media (max-width: 768px) {
            .nav-btn {
                width: 55px;
                height: 55px;
                bottom: 25px;
                top: auto;
                transform: none;
            }
            
            .prev-btn {
                left: 15px;
                top: auto;
                bottom: 30px;
            }
            
            .next-btn {
                right: 15px;
                top: auto;
                bottom: 30px;
            }
            
            .page-indicator {
                top: env(safe-area-inset-top, 20px);
                padding: 10px 25px;
                font-size: 16px;
            }
            
            .controls {
                bottom: 90px;
                gap: 15px;
                padding: 10px 20px;
            }
            
            .control-btn {
                width: 45px;
                height: 45px;
            }
            
            .app-title {
                top: 20px;
                left: 20px;
                font-size: 18px;
            }
            
            .quality-toggle {
                top: 20px;
                right: 20px;
                padding: 8px 15px;
                font-size: 14px;
            }
            
            #pdf-container {
                height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom) - 80px);
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div id="error-message"></div>
    <div id="loader">
        <div class="spinner"></div>
        <div class="loading-text">正在加载PDF文档...</div>
    </div>
    
    <div class="app-title">
        <i class="fas fa-file-pdf"></i>
        <span>PDF阅读器 - 翻页修复版</span>
    </div>
    
    <div class="quality-toggle">
        <i class="fas fa-star"></i>
        <span>高清模式</span>
    </div>
    
    <div id="pdf-container">
        <!-- 翻页区域指示器 -->
        <div class="page-nav-area prev-area" id="prev-area"></div>
        <div class="page-nav-area next-area" id="next-area"></div>
        
        <canvas id="pdf-canvas"></canvas>
    </div>
    
    <div class="scale-indicator" id="scale-indicator"></div>
    
    <button class="nav-btn prev-btn" aria-label="上一页">
        <i class="fas fa-chevron-left"></i>
    </button>
    <button class="nav-btn next-btn" aria-label="下一页">
        <i class="fas fa-chevron-right"></i>
    </button>
    
    <div class="controls">
        <div class="control-btn" id="zoom-in">
            <i class="fas fa-search-plus"></i>
        </div>
        <div class="control-btn" id="zoom-out">
            <i class="fas fa-search-minus"></i>
        </div>
        <div class="control-btn" id="fit-width">
            <i class="fas fa-arrows-alt-h"></i>
        </div>
        <div class="control-btn" id="fit-height">
            <i class="fas fa-arrows-alt-v"></i>
        </div>
        <div class="control-btn" id="fit-auto">
            <i class="fas fa-expand-arrows-alt"></i>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <script>
        // 初始化PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        const container = document.getElementById('pdf-container');
        const canvas = document.getElementById('pdf-canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: false });
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const prevBtn = document.querySelector('.prev-btn');
        const nextBtn = document.querySelector('.next-btn');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const fitWidthBtn = document.getElementById('fit-width');
        const fitHeightBtn = document.getElementById('fit-height');
        const fitAutoBtn = document.getElementById('fit-auto');
        const qualityToggle = document.querySelector('.quality-toggle');
        const scaleIndicator = document.getElementById('scale-indicator');
        const prevArea = document.getElementById('prev-area');
        const nextArea = document.getElementById('next-area');

        // 创建页面指示器
        const pageIndicator = document.createElement('div');
        pageIndicator.className = 'page-indicator';
        pageIndicator.style.opacity = '0';
        document.body.appendChild(pageIndicator);

        // 配置参数
        const config = {
            pdfUrl: './19140162.pdf',
            currentPage: 1,
            totalPages: 0,
            isRendering: false,
            pdfDoc: null,
            devicePixelRatio: window.devicePixelRatio || 1,
            isMobile: /iPhone|iPad|iPod|Android/i.test(navigator.userAgent),
            baseScale: 1.5,
            currentScale: 1.5,
            minScale: 0.5,
            maxScale: 3,
            highQuality: true,
            fitMode: 'auto', // auto, width, height
            lastRenderSize: { width: 0, height: 0 }
        };

        // 显示错误信息
        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            loader.style.display = 'none';
            
            setTimeout(() => {
                errorMessage.style.display = 'none';
            }, 10000);
        }

        // 更新页面指示器
        function updatePageIndicator() {
            if(config.totalPages === 0) return;
            
            pageIndicator.textContent = `${config.currentPage} / ${config.totalPages}`;
            pageIndicator.style.opacity = '1';
            
            setTimeout(() => {
                pageIndicator.style.opacity = '0';
            }, 3000);
        }

        // 显示缩放比例
        function showScaleIndicator() {
            const scalePercent = Math.round(config.currentScale * 100);
            scaleIndicator.textContent = `缩放: ${scalePercent}%`;
            scaleIndicator.style.opacity = '1';
            
            setTimeout(() => {
                scaleIndicator.style.opacity = '0';
            }, 2000);
        }

        // 计算最佳缩放比例
        function calculateOptimalScale(viewport, container) {
            const containerWidth = container.clientWidth - 40;
            const containerHeight = container.clientHeight - 40;
            
            const pageRatio = viewport.width / viewport.height;
            const containerRatio = containerWidth / containerHeight;
            
            let scale;
            
            if (config.fitMode === 'width') {
                // 适应宽度
                scale = containerWidth / viewport.width;
            } else if (config.fitMode === 'height') {
                // 适应高度
                scale = containerHeight / viewport.height;
            } else {
                // 自动适应
                if (containerRatio > pageRatio) {
                    // 高度限制
                    scale = containerHeight / viewport.height;
                } else {
                    // 宽度限制
                    scale = containerWidth / viewport.width;
                }
            }
            
            // 应用缩放限制
            return Math.min(Math.max(scale, config.minScale), config.maxScale);
        }

        // 加载PDF文档
        const loadPDF = async () => {
            try {
                if (!config.pdfDoc) {
                    const loadingTask = pdfjsLib.getDocument({
                        url: config.pdfUrl,
                        cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/cmaps/',
                        cMapPacked: true
                    });
                    
                    config.pdfDoc = await loadingTask.promise;
                    config.totalPages = config.pdfDoc.numPages;
                    updatePageIndicator();
                }
                
                await renderPage();
                setupEventListeners();
                
                setTimeout(() => {
                    loader.style.opacity = '0';
                    setTimeout(() => {
                        loader.style.display = 'none';
                    }, 500);
                }, 300);
                
            } catch (err) {
                console.error('PDF加载失败:', err);
                showError(`无法加载PDF文件: ${err.message || '请检查文件名或路径'}`);
            }
        };

        // 高清渲染函数
        const renderPage = async () => {
            if (config.isRendering || !config.pdfDoc) return;
            config.isRendering = true;
            
            try {
                const page = await config.pdfDoc.getPage(config.currentPage);
                
                // 获取PDF页面的原始尺寸
                const defaultViewport = page.getViewport({ scale: 1 });
                
                // 计算最佳缩放比例
                const scale = config.highQuality ? 
                    calculateOptimalScale(defaultViewport, container) : 
                    config.currentScale;
                
                config.currentScale = scale;
                
                // 应用设备像素比
                const renderScale = scale * (config.highQuality ? config.devicePixelRatio : 1);
                const viewport = page.getViewport({ scale: renderScale });
                
                // 检查尺寸是否变化，避免不必要的重绘
                const sizeChanged = 
                    config.lastRenderSize.width !== viewport.width || 
                    config.lastRenderSize.height !== viewport.height;
                
                if (!sizeChanged) {
                    config.isRendering = false;
                    return;
                }
                
                // 记录当前尺寸
                config.lastRenderSize = {
                    width: viewport.width,
                    height: viewport.height
                };
                
                // 设置canvas尺寸
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                
                // 设置canvas的CSS尺寸
                canvas.style.height = `${viewport.height / config.devicePixelRatio}px`;
                canvas.style.width = `${viewport.width / config.devicePixelRatio}px`;
                
                // 清除上一页内容
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 设置画布背景色为白色
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // 高清渲染设置
                ctx.save();
                ctx.scale(config.devicePixelRatio, config.devicePixelRatio);
                ctx.imageSmoothingEnabled = config.highQuality;
                ctx.imageSmoothingQuality = config.highQuality ? 'high' : 'medium';
                
                // 渲染PDF页面
                const renderContext = {
                    canvasContext: ctx,
                    viewport: viewport,
                    intent: 'display',
                    enableWebGL: true,
                    renderInteractiveForms: false
                };
                
                await page.render(renderContext).promise;
                ctx.restore();
                
                updatePageIndicator();
                showScaleIndicator();
                
            } catch (err) {
                console.error('页面渲染失败:', err);
                showError(`渲染页面失败: ${err.message}`);
            } finally {
                config.isRendering = false;
            }
        };

        // 翻页功能
        const goToPrevPage = () => {
            if (config.currentPage > 1) {
                config.currentPage--;
                renderPage();
            }
        };

        const goToNextPage = () => {
            if (config.currentPage < config.totalPages) {
                config.currentPage++;
                renderPage();
            }
        };

        // 事件监听设置
        const setupEventListeners = () => {
            // 键盘翻页
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') goToPrevPage();
                if (e.key === 'ArrowRight') goToNextPage();
            });
            
            // 按钮翻页
            prevBtn.addEventListener('click', goToPrevPage);
            nextBtn.addEventListener('click', goToNextPage);
            
            // 点击翻页区域
            prevArea.addEventListener('click', goToPrevPage);
            nextArea.addEventListener('click', goToNextPage);
            
            // 触摸滑动翻页
            let touchStartX = 0;
            let touchStartTime = 0;
            let isSwiping = false;
            
            container.addEventListener('touchstart', (e) => {
                if (e.touches.length > 1) return;
                touchStartX = e.touches[0].clientX;
                touchStartTime = Date.now();
                isSwiping = true;
            }, { passive: true });
            
            container.addEventListener('touchmove', (e) => {
                if (!isSwiping) return;
                e.preventDefault();
            }, { passive: false });
            
            container.addEventListener('touchend', (e) => {
                if (!isSwiping) return;
                isSwiping = false;
                
                const touchEndX = e.changedTouches[0].clientX;
                const diffX = touchStartX - touchEndX;
                const timeDiff = Date.now() - touchStartTime;
                
                if (Math.abs(diffX) > 50 && timeDiff < 300) {
                    if (diffX > 0) goToNextPage();
                    else goToPrevPage();
                }
            }, { passive: true });
            
            // 点击左右边缘翻页
            container.addEventListener('click', (e) => {
                const rect = container.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const width = rect.width;
                
                if (clickX < width * 0.3) {
                    goToPrevPage();
                } else if (clickX > width * 0.7) {
                    goToNextPage();
                }
            });
            
            // 窗口大小变化时重新渲染
            let resizeTimer;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    if (!config.isRendering) {
                        renderPage();
                    }
                }, 300);
            });
            
            // 防止移动端缩放
            document.addEventListener('gesturestart', (e) => {
                e.preventDefault();
            });
            
            document.addEventListener('dblclick', (e) => {
                e.preventDefault();
            });
            
            // 缩放控制
            zoomInBtn.addEventListener('click', () => {
                config.fitMode = 'manual';
                config.currentScale = Math.min(config.currentScale + 0.1, config.maxScale);
                renderPage();
            });
            
            zoomOutBtn.addEventListener('click', () => {
                config.fitMode = 'manual';
                config.currentScale = Math.max(config.currentScale - 0.1, config.minScale);
                renderPage();
            });
            
            fitWidthBtn.addEventListener('click', () => {
                config.fitMode = 'width';
                renderPage();
            });
            
            fitHeightBtn.addEventListener('click', () => {
                config.fitMode = 'height';
                renderPage();
            });
            
            fitAutoBtn.addEventListener('click', () => {
                config.fitMode = 'auto';
                renderPage();
            });
            
            // 高清模式切换
            qualityToggle.addEventListener('click', () => {
                config.highQuality = !config.highQuality;
                qualityToggle.innerHTML = config.highQuality ? 
                    '<i class="fas fa-star"></i><span>高清模式</span>' : 
                    '<i class="fas fa-star-half-alt"></i><span>标准模式</span>';
                renderPage();
            });
        };

        // 初始化
        window.onload = () => {
            // 检测移动端并调整参数
            if (config.isMobile) {
                document.body.classList.add('mobile');
                config.devicePixelRatio = Math.min(window.devicePixelRatio, 2);
                
                // 添加安全区域适配
                container.style.paddingBottom = 'calc(env(safe-area-inset-bottom) + 20px)';
            }
            
            loadPDF();
        };
    </script>
</body>
</html>